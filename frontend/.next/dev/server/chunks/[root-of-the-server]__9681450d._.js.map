{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 54, "column": 0}, "map": {"version":3,"sources":["file:///D:/Muhammad%20Shariq/GIAIC/Hackathon/Hackathon%202/Phase3/frontend/app/api/auth/jwt/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { Pool, neonConfig } from '@neondatabase/serverless';\nimport ws from 'ws';\nimport crypto from 'crypto';\n\n// Enable WebSocket for serverless environments (Vercel)\nneonConfig.webSocketConstructor = ws;\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n});\n\nconst SECRET = process.env.BETTER_AUTH_SECRET!;\n\nfunction base64url(data: string): string {\n  return Buffer.from(data).toString('base64url');\n}\n\nfunction createJWT(payload: Record<string, any>): string {\n  const header = { alg: 'HS256', typ: 'JWT' };\n  const now = Math.floor(Date.now() / 1000);\n  const fullPayload = {\n    ...payload,\n    iat: now,\n    exp: now + 86400, // 24 hours\n  };\n\n  const encodedHeader = base64url(JSON.stringify(header));\n  const encodedPayload = base64url(JSON.stringify(fullPayload));\n  const signature = crypto\n    .createHmac('sha256', SECRET)\n    .update(`${encodedHeader}.${encodedPayload}`)\n    .digest('base64url');\n\n  return `${encodedHeader}.${encodedPayload}.${signature}`;\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Get session token from cookie\n    const cookieHeader = request.headers.get('cookie') || '';\n    const sessionMatch = cookieHeader.match(/better-auth\\.session_token=([^;]+)/);\n    let sessionToken = sessionMatch ? decodeURIComponent(sessionMatch[1]) : null;\n\n    if (!sessionToken) {\n      return NextResponse.json({ error: 'No session found' }, { status: 401 });\n    }\n\n    // Better Auth stores token with signature (token.signature), extract just the token part\n    const tokenPart = sessionToken.split('.')[0];\n\n    // Look up session in PostgreSQL database\n    const result = await pool.query(\n      'SELECT s.*, u.id as \"userId\", u.email, u.name FROM \"session\" s JOIN \"user\" u ON s.\"userId\" = u.id WHERE s.token = $1',\n      [tokenPart]\n    );\n\n    const session = result.rows[0];\n\n    if (!session) {\n      return NextResponse.json({ error: 'Invalid session' }, { status: 401 });\n    }\n\n    // Check if session is expired\n    const expiresAt = new Date(session.expiresAt).getTime();\n    if (expiresAt < Date.now()) {\n      return NextResponse.json({ error: 'Session expired' }, { status: 401 });\n    }\n\n    // Create JWT with user info\n    const jwt = createJWT({\n      sub: session.userId,\n      email: session.email,\n      name: session.name,\n    });\n\n    return NextResponse.json({ token: jwt });\n  } catch (error: any) {\n    console.error('[JWT Generation Error]', error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;;;;;AAEA,wDAAwD;AACxD,kLAAU,CAAC,oBAAoB,GAAG,oKAAE;AAEpC,MAAM,OAAO,IAAI,4KAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,kBAAkB;AAE7C,SAAS,UAAU,IAAY;IAC7B,OAAO,OAAO,IAAI,CAAC,MAAM,QAAQ,CAAC;AACpC;AAEA,SAAS,UAAU,OAA4B;IAC7C,MAAM,SAAS;QAAE,KAAK;QAAS,KAAK;IAAM;IAC1C,MAAM,MAAM,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;IACpC,MAAM,cAAc;QAClB,GAAG,OAAO;QACV,KAAK;QACL,KAAK,MAAM;IACb;IAEA,MAAM,gBAAgB,UAAU,KAAK,SAAS,CAAC;IAC/C,MAAM,iBAAiB,UAAU,KAAK,SAAS,CAAC;IAChD,MAAM,YAAY,gHAAM,CACrB,UAAU,CAAC,UAAU,QACrB,MAAM,CAAC,GAAG,cAAc,CAAC,EAAE,gBAAgB,EAC3C,MAAM,CAAC;IAEV,OAAO,GAAG,cAAc,CAAC,EAAE,eAAe,CAAC,EAAE,WAAW;AAC1D;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,gCAAgC;QAChC,MAAM,eAAe,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa;QACtD,MAAM,eAAe,aAAa,KAAK,CAAC;QACxC,IAAI,eAAe,eAAe,mBAAmB,YAAY,CAAC,EAAE,IAAI;QAExE,IAAI,CAAC,cAAc;YACjB,OAAO,4JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,yFAAyF;QACzF,MAAM,YAAY,aAAa,KAAK,CAAC,IAAI,CAAC,EAAE;QAE5C,yCAAyC;QACzC,MAAM,SAAS,MAAM,KAAK,KAAK,CAC7B,wHACA;YAAC;SAAU;QAGb,MAAM,UAAU,OAAO,IAAI,CAAC,EAAE;QAE9B,IAAI,CAAC,SAAS;YACZ,OAAO,4JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,8BAA8B;QAC9B,MAAM,YAAY,IAAI,KAAK,QAAQ,SAAS,EAAE,OAAO;QACrD,IAAI,YAAY,KAAK,GAAG,IAAI;YAC1B,OAAO,4JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,4BAA4B;QAC5B,MAAM,MAAM,UAAU;YACpB,KAAK,QAAQ,MAAM;YACnB,OAAO,QAAQ,KAAK;YACpB,MAAM,QAAQ,IAAI;QACpB;QAEA,OAAO,4JAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAI;IACxC,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,4JAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}